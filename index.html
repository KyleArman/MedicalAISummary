<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Patient Summary</title>
        <link href="bootstrap.min.css" rel="stylesheet">
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 10px;
                background-color: #f8f9fa;
            }

            .top-image {
                max-width: 100%;
                display: block;
                margin: 0 auto 15px auto;
            }

            .summary-container {
                background-color: #fff;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }

            .box {
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 15px;
                background-color: #f1f3f5;
            }

            .box h4 {
                margin-bottom: 10px;
                font-size: 1.2rem;
            }

            .value {
                font-weight: bold;
            }

            .yes {
                color: blue;
            }

            .no {
                color: red;
            }

            .dr-row {
                display: flex;
                flex-wrap: wrap;
                padding: 5px 0;
                font-size: 1rem; /* base font larger */
            }

            .dr-row div {
                padding: 4px 6px;
            }

            /* Column flexes, remove strict min-width */
            .col-test { flex: 25%; }
            .col-indicator { flex: 10%; text-align: center; }
            .col-symptom { flex: 40%; }
            .col-consent { flex: 25%; }

            /* Mobile responsiveness */
            @media (max-width: 576px) {
                .dr-row {
                    flex-direction: column;
                    font-size: 1rem; /* readable on small screen */
                    gap: 4px;
                }
                .col-test, .col-indicator, .col-symptom, .col-consent {
                    flex: 100%;
                    min-width: auto;
                    text-align: left;
                }
            }
            .original-size {
                width: 100%;      /* fills most of the screen */
                max-width: 75%; /* donâ€™t exceed desktop size */
                height: auto;
            }

            .indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                display: inline-block;
            }
            .indicator.blue {
                background-color: #0d6efd; /* Bootstrap primary */
            }
            .indicator.red {
                background-color: #dc3545; /* Bootstrap danger */
            }
        </style>
    </head>
    <body>

    <div class="summary-container">

        <!-- Top image inside div -->
        <div class="text-center mb-3">
            <h4>UTM Health Center Map</h4>
            <img src="PKUMap.png" class="original-size" alt="PKU Map">
        </div>

        <!-- "To Do" Box -->
        <div class="box">
            <h4>Patient's Tasks</h4>
            <ul class="list-group">
                <li id="liBloodTest" class="list-group-item">Blood Test (Lab Sample)</li>
                <li id="liUrineTest" class="list-group-item">Urine Test (Lab Sample)</li>
                <li id="liRbst" class="list-group-item">Rapid Blood Sugar Test (Lab Sample)</li>
                <li id="liXRay" class="list-group-item">X-Ray (Diagnostic Lab)</li>
                <li id="liBPTest" class="list-group-item">Blood Pressure Test (Doctor's Room)</li>
                <li class="list-group-item">See the Doctor</li>
                <li class="list-group-item">Collect Prescribed Medicine at the Pharmacy</li>
            </ul>
        </div>

        <div class="box">

            <!-- Doctor View Button -->
            <button class="btn btn-outline-primary text-start mb-2"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#drView"
                    aria-expanded="true"
                    aria-controls="drView">
                Doctor View
            </button>

            <!-- Collapsible Doctor View -->
            <div class="collapse show" id="drView">

                <!-- Header Row -->
                <div class="row fw-bold mb-2 text-muted dr-row">
                    <div class="col-test">Medical Test</div>
                    <div class="col-indicator text-center">Indicator</div>
                    <div class="col-symptom">Symptoms</div>
                    <div class="col-consent">Consent</div>
                </div>

                <!-- Blood Test -->
                <div class="row py-2 align-items-center dr-row" id="bloodRow">
                    <div class="col-test">Blood Test</div>
                    <div class="col-indicator">
                        <span id="bloodIndicator" class="indicator"></span>
                    </div>
                    <div class="col-symptom" id="bloodSymptoms"></div>
                    <div class="col-consent" id="btConsent"></div>
                </div>

                <!-- Urine Test -->
                <div class="row py-2 align-items-center dr-row" id="urineRow">
                    <div class="col-test">Urine Test</div>
                    <div class="col-indicator">
                        <span id="urineIndicator" class="indicator"></span>
                    </div>
                    <div class="col-symptom" id="urineSymptoms"></div>
                    <div class="col-consent" id="utConsent"></div>
                </div>

                <!-- Rapid Blood Sugar Test -->
                <div class="row py-2 align-items-center dr-row" id="rbstRow">
                    <div class="col-test">Rapid Blood Sugar Test</div>
                    <div class="col-indicator">
                        <span id="rbstIndicator" class="indicator"></span>
                    </div>
                    <div class="col-symptom" id="rbstSymptoms"></div>
                    <div class="col-consent" id="rbstConsent"></div>
                </div>

                <!-- X-Ray -->
                <div class="row py-2 align-items-center dr-row" id="xRayRow">
                    <div class="col-test">X-Ray</div>
                    <div class="col-indicator">
                        <span id="xRayIndicator" class="indicator"></span>
                    </div>
                    <div class="col-symptom" id="xRaySymptoms"></div>
                    <div class="col-consent" id="xrConsent"></div>
                </div>

                <!-- Blood Pressure Test -->
                <div class="row py-2 align-items-center dr-row" id="bpRow">
                    <div class="col-test">Blood Pressure Test</div>
                    <div class="col-indicator">
                        <span id="bpIndicator" class="indicator blue"></span>
                    </div>
                    <div class="col-symptom" id="bpSymptoms"></div>
                    <div class="col-consent" id="bpConsent"></div>
                </div>

            </div>
        </div>


        <!-- GDrive Link -->
        <div class="text-center mt-3">
            <a id="gDriveLink" href="#" target="_blank" class="btn btn-link">View Patient Virtual Card</a>
        </div>

    </div>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);

        // âœ… To Do: only show test if its boolean is 1, no "Pending" text
        function toggleVisibility(testKey, liId) {
            const value = params.get(testKey);
            const li = document.getElementById(liId);
            li.style.display = (value === "1") ? "list-item" : "none";
        }

        toggleVisibility("bloodTest", "liBloodTest");
        toggleVisibility("urineTest", "liUrineTest");
        toggleVisibility("rapidBloodSugarTest", "liRbst");
        toggleVisibility("xRay", "liXRay");
        toggleVisibility("bloodPressureTest", "liBPTest");

        // Build symptoms text with duration for fever and cough
        function buildSymptoms(symptomKeys) {
            const labels = {
                fever: "Fever",
                cough: "Cough",
                headache: "Headache",
                urinaryHesitancy: "Urinary Hesitancy",
                urinaryFrequency: "Urinary Frequency",
                amenorrhea: "Amenorrhea"
            };

            const found = symptomKeys
                .filter(k => params.get(k) === "1")
                .map(k => {
                    if (k === "fever") {
                        const d = parseInt(params.get("durationFever")) || 0;
                        return `Fever (${d} days)`;
                    }
                    if (k === "cough") {
                        const d = parseInt(params.get("durationCough")) || 0;
                        return `Cough (${d} days)`;
                    }
                    return labels[k];
                });

            return found.length ? found.join(", ") : null;
        }

        // Update Doctor View row with correct consent logic
        function updateDrView(testKey, consentKey, rowId, indicatorId, symptomsId, consentId, symptomKeys) {
            const row = document.getElementById(rowId);
            const indicator = document.getElementById(indicatorId);
            const symptomsEl = document.getElementById(symptomsId);
            const consentEl = document.getElementById(consentId);

            const consentValue = params.get(consentKey);
            const symptomText = buildSymptoms(symptomKeys);

            if (!symptomText) {
                row.style.display = "none";
                return;
            }

            row.style.display = "flex";
            symptomsEl.textContent = symptomText;

            let finalConsent = "-";

            // Fever â†’ â‰¥3 days
            if (testKey === "bloodTest") {
                const d = parseInt(params.get("durationFever")) || 0;

                if (d < 3) {
                    finalConsent = "-";
                } else {
                    finalConsent = (consentValue === "1") ? "Consent" : "No Consent";
                }
            }
            // Cough â†’ â‰¥21 days
            else if (testKey === "xRay") {
                const d = parseInt(params.get("durationCough")) || 0;

                if (d < 21) {
                    finalConsent = "-";
                } else {
                    finalConsent = (consentValue === "1") ? "Consent" : "No Consent";
                }
            }
            // Headache â†’ always "-"
            else if (testKey === "bloodPressureTest") {
                finalConsent = "";
            }
            // Other tests â†’ consent boolean
            else {
                finalConsent = (consentValue === "1") ? "Consent" : "No Consent";
            }

            consentEl.textContent = finalConsent;

            // ðŸ”µ / ðŸ”´ Indicator logic
            indicator.className = "indicator " + (finalConsent === "Consent" ? "blue" : "red");
            if (testKey === "bloodPressureTest"){
                indicator.className = "indicator blue";
            }
        }

        // Apply for each test
        updateDrView(
            "bloodTest",
            "btConsent",
            "bloodRow",
            "bloodIndicator",
            "bloodSymptoms",
            "btConsent",
            ["fever"]
        );

        updateDrView(
            "urineTest",
            "utConsent",
            "urineRow",
            "urineIndicator",
            "urineSymptoms",
            "utConsent",
            ["urinaryHesitancy", "amenorrhea"]
        );

        updateDrView(
            "rapidBloodSugarTest",
            "rbstConsent",
            "rbstRow",
            "rbstIndicator",
            "rbstSymptoms",
            "rbstConsent",
            ["urinaryFrequency"]
        );

        updateDrView(
            "xRay",
            "xrConsent",
            "xRayRow",
            "xRayIndicator",
            "xRaySymptoms",
            "xrConsent",
            ["cough"]
        );

        updateDrView(
            "bloodPressureTest",
            "bpConsent",
            "bpRow",
            "bpIndicator",
            "bpSymptoms",
            "bpConsent",
            ["headache"]
        );
    </script>
    </body>
</html>
