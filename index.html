<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Patient Summary</title>
        <link href="bootstrap.min.css" rel="stylesheet">
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 10px;
                background-color: #f8f9fa;
            }

            .top-image {
                max-width: 120px;
                display: block;
                margin: 0 auto 15px auto;
            }

            .summary-container {
                background-color: #fff;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }

            .box {
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 15px;
                background-color: #f1f3f5;
            }

            .box h4 {
                margin-bottom: 10px;
                font-size: 1.2rem;
            }

            .value {
                font-weight: bold;
            }

            .yes {
                color: blue;
            }

            .no {
                color: red;
            }

            .dr-row {
                display: flex;
                flex-wrap: wrap;
                padding: 5px 0;
                font-size: 0.95rem;
            }

            .dr-row div {
                padding: 4px 6px;
            }

            .col-test { flex: 25%; min-width: 120px; }
            .col-symptom { flex: 40%; min-width: 140px; }
            .col-consent { flex: 35%; min-width: 100px; }

            @media (max-width: 576px) {
                .dr-row { font-size: 0.85rem; }
                .col-test, .col-symptom, .col-consent { min-width: 100%; flex: 100%; margin-bottom: 4px; }
            }
        </style>
    </head>
    <body>

    <!-- Top Image -->
    <img src="top_logo.png" class="top-image" alt="Patient QR Code">

    <div class="summary-container">

        <!-- Top image inside div -->
        <div class="text-center mb-3">
            <img src="PKUMap.png" class="rounded-circle" width="100" alt="PKU Map">
        </div>

        <!-- "To Do" Box -->
        <div class="box">
            <h4>To Do</h4>
            <ul class="list-group">
                <li id="liBloodTest" class="list-group-item">Blood Test (Lab Sample)</li>
                <li id="liUrineTest" class="list-group-item">Urine Test (Lab Sample)</li>
                <li id="liRbst" class="list-group-item">Rapid Blood Sugar Test (Lab Sample)</li>
                <li id="liXRay" class="list-group-item">X-Ray</li>
                <li id="liBPTest" class="list-group-item">Blood Pressure Test</li>
                <li class="list-group-item">See the Doctor</li>
                <li class="list-group-item">Collect Prescribed Medicine at the Pharmacy</li>
            </ul>
        </div>

        <div class="box">

            <!-- Doctor View Button -->
            <button class="btn btn-outline-primary text-start mb-2"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#drView"
                    aria-expanded="true"
                    aria-controls="drView">
                Doctor View
            </button>

            <!-- Collapsible Doctor View -->
            <div class="collapse show" id="drView">

                <!-- Header Row -->
                <div class="row fw-bold mb-2 text-muted px-2">
                    <div class="col-4">Test</div>
                    <div class="col-5">Symptoms</div>
                    <div class="col-3">Consent</div>
                </div>

                <!-- Blood Test -->
                <div class="row py-2 align-items-center px-2">
                    <div class="col-4">Blood Test</div>
                    <div class="col-5" id="bloodSymptoms"></div>
                    <div class="col-3" id="btConsent"></div>
                </div>

                <!-- Urine Test -->
                <div class="row py-2 align-items-center px-2">
                    <div class="col-4">Urine Test</div>
                    <div class="col-5" id="urineSymptoms"></div>
                    <div class="col-3" id="utConsent"></div>
                </div>

                <!-- Rapid Blood Sugar Test -->
                <div class="row py-2 align-items-center px-2">
                    <div class="col-4">Rapid Blood Sugar Test</div>
                    <div class="col-5" id="rbstSymptoms"></div>
                    <div class="col-3" id="rbstConsent"></div>
                </div>

                <!-- X-Ray -->
                <div class="row py-2 align-items-center px-2">
                    <div class="col-4">X-Ray</div>
                    <div class="col-5" id="xRaySymptoms"></div>
                    <div class="col-3" id="xrConsent"></div>
                </div>

                <!-- Blood Pressure Test -->
                <div class="row py-2 align-items-center px-2">
                    <div class="col-4">Blood Pressure Test</div>
                    <div class="col-5" id="bpSymptoms"></div>
                    <div class="col-3" id="bpConsent"></div>
                </div>

            </div>
        </div>


        <!-- GDrive Link -->
        <div class="text-center mt-3">
            <a id="gDriveLink" href="#" target="_blank" class="btn btn-link">View Patient Virtual Card</a>
        </div>

    </div>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);

        // ✅ To Do: only show test if its boolean is 1, no "Pending" text
        function toggleVisibility(testKey, liId) {
            const value = params.get(testKey);
            const li = document.getElementById(liId);
            li.style.display = (value === "1") ? "list-item" : "none";
        }

        toggleVisibility("bloodTest", "liBloodTest");
        toggleVisibility("urineTest", "liUrineTest");
        toggleVisibility("rapidBloodSugarTest", "liRbst");
        toggleVisibility("xRay", "liXRay");
        toggleVisibility("bloodPressureTest", "liBPTest");

        // Build symptoms text with duration for fever and cough
        function buildSymptoms(symptomKeys) {
            const labels = {
                fever: "Fever",
                cough: "Cough",
                headache: "Headache",
                urinaryHesitancy: "Urinary Hesitancy",
                urinaryFrequency: "Urinary Frequency",
                amenorrhea: "Amenorrhea"
            };

            const found = symptomKeys
                .filter(k => params.get(k) === "1")
                .map(k => {
                    if (k === "fever") {
                        const dur = parseInt(params.get("durationFever")) || 0;
                        return dur ? `Fever (${dur} days)` : "Fever";
                    }
                    if (k === "cough") {
                        const dur = parseInt(params.get("durationCough")) || 0;
                        return dur ? `Cough (${dur} days)` : "Cough";
                    }
                    return labels[k];
                });

            return found.length > 0 ? found.join(", ") : null;
        }

        // Update Doctor View row with correct consent logic
        function updateDrView(testKey, consentKey, symptomsId, consentId, symptomKeys) {
            const consentValue = params.get(consentKey);
            const symptomsEl = document.getElementById(symptomsId);
            const consentEl = document.getElementById(consentId);

            const symptomText = buildSymptoms(symptomKeys);

            let finalConsent = "-";

            if (symptomText) {
                // Fever consent
                if (testKey === "bloodTest" && symptomKeys.includes("fever")) {
                    const dur = parseInt(params.get("durationFever")) || 0;
                    finalConsent = dur >= 3 ? "Consent" : "-";
                }
                // Cough consent
                else if (testKey === "xRay" && symptomKeys.includes("cough")) {
                    const dur = parseInt(params.get("durationCough")) || 0;
                    finalConsent = dur >= 21 ? "Consent" : "-";
                }
                // Headache → always "-"
                else if (testKey === "bloodPressureTest" && symptomKeys.includes("headache")) {
                    finalConsent = "-";
                }
                // Other tests → normal consent boolean
                else {
                    finalConsent = (consentValue === "1") ? "Consent" : "No Consent";
                }
            }

            symptomsEl.textContent = symptomText || "No symptom";
            consentEl.textContent = finalConsent;
        }

        // Apply for each test
        updateDrView("bloodTest", "btConsent", "bloodSymptoms", "btConsent", ["fever"]);
        updateDrView("urineTest", "utConsent", "urineSymptoms", "utConsent", ["urinaryHesitancy","amenorrhea"]);
        updateDrView("rapidBloodSugarTest", "rbstConsent", "rbstSymptoms", "rbstConsent", ["urinaryFrequency"]);
        updateDrView("xRay", "xrConsent", "xRaySymptoms", "xrConsent", ["cough"]);
        updateDrView("bloodPressureTest", "bpConsent", "bpSymptoms", "bpConsent", ["headache"]);
        </script>
    </body>
</html>
